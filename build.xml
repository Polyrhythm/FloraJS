<project name="FloraJS" default="build.dev">

  <loadproperties srcfile="build.properties" />

  <import file="${buildr.dir}"/>

  <loadfile property="license" srcfile="license.txt" />

  <tstamp>
    <format property="build.time"
            pattern="MMMM d, yyyy hh:mm:ss"
            locale="en,US"/>
  </tstamp>

  <target name="init">
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${jsdoc.output}"/>
    <mkdir dir="${DemoBuild.dir}"/>
  </target>

  <target name="clean">
    <delete dir="${build.dir}"/>
    <delete dir="${jsdoc.output}"/>
    <delete dir="${DemoBuild.dir}"/>
  </target>

  <target name="build.dev" depends="clean,init,concatenate,validate,validateDemos">
  </target>

  <target name="build.release" depends="clean,init,validate,validateDemos,concatenate,document,minify,bake">
  </target>

  <taskdef name="jshint" classname="com.philmander.jshint.JsHintAntTask"
    classpath="${lib.dir}/jshint/ant-jshint-0.3.1-deps.jar" />

  <target name="validate">
    <jshint dir="${src.dir}" includes="**/*.js"
      optionsFile="${lib.dir}/jshint/options.properties" globals="exports: true, Modernizr: true, console: true" />
  </target>

  <target name="validateDemos">
    <jshint dir="${DemoSrc.dir}" includes="**/*.js"
      optionsFile="${lib.dir}/jshint/options.properties" globals="exports: true, Modernizr: true, console: true" />
  </target>

  <target name="CSSLintDemos">
    <csslint>
      <fileset dir="${DemoCSS.dir}" includes="**/*.css" />
    </csslint>
  </target>

  <target name="concatenate">
    <concat destfile="${build.dir}/build.js" fixlastline="yes" eol="lf">
      <header trimleading="yes">/*ignore!
        ${license}
        */
        /* Build time: ${build.time} */
        /** @namespace */
        var Flora = {}, exports = Flora;

        (function(exports) {
      </header>
      <filelist dir="${src.dir}" files="requestanimframe.js,config.js,elementlist.js,florasystem.js,utils.js,vector.js,defaultcolorlist.js,colorpalette.js,colortable.js,borderpalette.js,simplexnoise.js,interface.js,world.js,camera.js,obj.js,mover.js,walker.js,oscillator.js,particle.js,particlesystem.js,liquid.js,attractor.js,repeller.js,heat.js,cold.js,light.js,oxygen.js,food.js,predator.js,sensor.js,flowfieldmarker.js,flowfield.js,connector.js,point.js,caption.js,stats.js"/>
      <footer trimleading="yes">}(exports));</footer>
    </concat>
  </target>

  <target name="document">
    <delete dir="${jsdoc.output}"/>
    <mkdir dir="${jsdoc.output}"/>
    <apply executable="java" failonerror="true" parallel="true">
      <fileset dir="${src.dir}" includes="**/*.js"/>
      <arg line="-jar"/>
      <arg path="${jsdoc}"/>
      <arg path="${jsdoc.run}"/>
      <arg line="-t=${jsdoc.templates}"/>
      <arg line="-d=${jsdoc.output}"/>
      <srcfile/>
    </apply>
  </target>

  <target name="minify">

    <apply executable="java" failonerror="true">

      <fileset dir="${build.dir}" includes="*.js" excludes="*-min.js"/>
      <mapper type="glob" from="*.js" to="${build.dir}/*-min.js"/>

      <arg line="-jar"/>
      <arg path="${closure}"/>
      <arg line="${closure.options}"/>

      <arg line="--js"/>
      <srcfile/>

      <arg line="--js_output_file"/>
      <targetfile/>

    </apply>

  </target>

  <target name="minifyDemos">

    <apply executable="java" failonerror="true">

      <fileset dir="${DemoSrc.dir}" includes="*.js" excludes="*-min.js"/>
      <mapper type="glob" from="*.js" to="${DemoBuild.dir}/*-min.js"/>

      <arg line="-jar"/>
      <arg path="${closure}"/>
      <arg line="${closure.options}"/>

      <arg line="--js"/>
      <srcfile/>

      <arg line="--js_output_file"/>
      <targetfile/>

    </apply>

  </target>

  <target name="test">

    <phantomjs driver="${phantomjs.driver}">
      <fileset dir="${tests.dir}" includes="*.html" />
    </phantomjs>

  </target>

  <target name="bake">
    <replaceregexp match="@VERSION@" replace="${version}" flags="g" byline="true">
      <fileset dir="${build.dir}" includes="**/*"/>
    </replaceregexp>
  </target>

</project>